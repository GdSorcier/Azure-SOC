# Building a SOC + Honeynet in Azure (Live Traffic)
![Azure Cloud Honeynet / SOC](https://imgur.com/jCa5nD3.jpg)

## Introduction

In this project, a small-scale honeynet was set up on the Azure platform. The primary goal was to gather and scrutinise log data from various sources, which were then integrated into a Log Analytics workspace. Microsoft Sentinel was utilised for exploiting these logs to develop attack visualisation maps, generate alerts, and create incidents. Azure Sentinel tracked the metrics in a non-secure setting over a period of 24 hours. After this period, enhanced security measures were put in place to strengthen the virtual environment. Subsequently, another 24 hours of metric tracking was performed. This report showcases the findings from these two measurement phases. 
The metrics analysed included:
-	SecurityEvent (Windows Event Logs)
-	Syslog (Linux Event Logs)
-	SecurityAlert (Alerts triggered in Log Analytics)
-	SecurityIncident (Incidents generated by Sentinel)
-	AzureNetworkAnalytics_CL (Tracking of Malicious Flows allowed into the honeynet)

## Technologies, Azure Components and Regulations Used

-	Azure Virtual Network (VNet) 
-	Azure Network Security Groups (NSG)
-	Virtual Machines (2 Windows VMs, 1 Linux VM)
-	Log Analytics Workspace with Kusto Query Language (KQL) Queries
- Azure Key Vault for Secure Secrets Management
-	Azure Storage Account for Data Storage
-	Microsoft Sentinel for Security Information and Event Management (SIEM)
-	Microsoft Defender for Cloud to Protect Cloud Resources
-	Windows Remote Desktop for Remote Access
-	Command Line Interface (CLI) for System Management
-	PowerShell for Automation and Configuration Management
-	[NIST SP 800-53](https://csrc.nist.gov/pubs/sp/800/53/r5/upd1/final) Revision 5 for Security Controls
-	[NIST SP 800-61 Revision 2](https://www.nist.gov/privacy-framework/nist-sp-800-61) for Incident Handling Guidance


## Architecture Before Hardening / Security Controls
![Architecture Diagram](https://imgur.com/Av8g4Eo.jpg)

For the "BEFORE" metrics, all resources were originally deployed, exposed to the internet for threat actors to discover and attempt to break into the virtual machines. The Virtual Machines had both their Network Security Groups and built-in firewalls wide open, and all other resources including SQL database, storage account and key vault were deployed with public endpoints visible on the Internet meaning no use for Private Endpoints.

## Attack Maps Before Hardening / Security Controls
**This attack map shows the traffic allowed by a Network Security Group with all inbound traffic allowed** 
![Malicious Flows](https://imgur.com/bYsGlTH.jpg)

**This attack map shows all the attempts threat actors trying to access the Microsoft SQL Database Server within the Windows virtual machine**
![SQL Auth](https://imgur.com/36wG4GN.jpg)

**This attack map shows all the attempts threat actors trying to access the Windows virtual machine via RDP**
![RDP Access](https://imgur.com/fcbWMqL.jpg)

**This attack map shows all the attempts threat actors trying to access the Linux virtual machine via SSH**
![SSH Access](https://imgur.com/hU1F7xz.jpg)


## Metrics Before Hardening / Security Controls
The following table shows the metrics we measured in our insecure environment for 24 hours: 
Start Time 2023-12-13 10:48:46
Stop Time 2023-12-14 10:48:46

| Metrics                  | Count
| ------------------------ | -----
| SecurityEvent            | 27457
| Syslog                   | 4517
| SecurityAlert            | 19
| SecurityIncident         | 371
| AzureNetworkAnalytics_CL | 2707


## Architecture After Hardening / Security Controls
![Architecture Diagram](https://imgur.com/Gr7Ansz.jpg)

For the "AFTER" phase of the project, the environment underwent a series of enhancements to align with NIST SP 800-53 Rev5 SC-7 Boundary Protection control. The implemented security enhancements included:
-	**Network Security Groups (NSGs):** The NSGs were tightened by restricting all inbound and outbound traffic, except for specific public IP addresses granted access to the virtual machines. This measure ensured that only verified, trustworthy traffic could interact with the virtual machines.
-	**Built-in Azure Firewalls:** The built-in firewalls on the virtual machines were meticulously configured to prevent unauthorised entries and shield the resources from harmful connections. This involved a detailed adjustment of firewall rules tailored to the services and roles of each virtual machine, effectively reducing the potential attack vectors available to malicious entities.
-	**Private Endpoints:** To strengthen the security of Azure Key Vault and Storage Containers, Public Endpoints were substituted with Private Endpoints. This adjustment protected these critical resources within the virtual network against public internet exposure.
-	**Subnet Strategies:** An additional security layer was added through subnetting specifically for Azure Key Vault and Storage Containers. This created a segregated traffic flow and an extra layer of defence for these endpoints.


## Attack Maps After Hardening / Security Controls

```All map queries actually returned no results due to no instances of malicious activity for the 24 hour period after hardening.```

## Metrics After Hardening / Security Controls

The following table shows the metrics we measured in our environment for another 24 hours, but after we have applied security controls:
Start Time 2023-12-14 15:56:02
Stop Time	2023-12-15 15:56:02

| Metrics                  | Count
| ------------------------ | -----
| SecurityEvent            | 11773
| Syslog                   | 1
| SecurityAlert            | 0
| SecurityIncident         | 0
| AzureNetworkAnalytics_CL | 0


## Impact of Security Controls

| Metrics                  | Change post-hardening environment
| ------------------------ | -----
| SecurityEvent            |57.12%
| Syslog                   | 99.98%
| SecurityAlert            | 100%
| SecurityIncident         | 100%
| AzureNetworkAnalytics_CL | 100%


## Conclusion

In this project, we built a mini honeynet on Microsoft Azure, integrating logs into a Log Analytics workspace and using Microsoft Sentinel for alerts and incident creation. We observed a significant reduction in security events after applying security controls, proving their effectiveness. Increased network usage by regular users could potentially lead to more security alerts post-implementation.

The project was not only enjoyable but also a crucial lesson in the importance of robust security measures. The contrast in metrics before and after implementing security controls clearly shows the difference between vulnerable and secure environments. Key practices like implementing firewall rules, using private endpoints, and restricting public internet access are essential to safeguard against threats and unauthorised access to critical assets.
